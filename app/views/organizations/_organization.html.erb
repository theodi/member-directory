<div class='organization' vocab="http://schema.org/" typeOf="Organization">

  <h2 property="name"<% if @preview %> data-bind="text: name"<% end %>><%= organization.name %></h2>

  <% unless @member.supporter? %>
    <div class='organization-logo pull-right' 
         style='background-image: url(<%= organization.logo.rectangular.url %>)'
         data-bind='style: {backgroundImage: imageSrc}' >
    </div>
  <% end %>

  <div class='<%= @member.supporter? ? '' : 'organization-content' %>'>
  
    <div>
      <div class='contact-detail'>
        <i class='icon icon-home'></i> <a property="url" data-bind="text: url, attr: {href: url}" href='<%= organization.url %>'><%= organization.url%></a>
      </div>

      <% if @preview || organization.cached_contact_name.present? %>
        <div data-bind="visible: contactName().length > 0" class='contact-detail'>
          <i class='icon-user'></i> <span property="contactPoint" data-bind="text: contactName"><%= organization.cached_contact_name %></span>
        </div>
      <% end %>
    
      <% if @preview || organization.cached_contact_email.present? %>
        <div data-bind="visible: contactEmail().length > 0" class='contact-detail'>
          <i class='icon-envelope-alt'></i> <a property="email" data-bind="text: contactEmail, attr: {href: mailto}" href='mailto:<%= organization.cached_contact_email %>'><%= organization.cached_contact_email %></a>
        </div>
      <% end %>
    
      <% if @preview || organization.cached_contact_phone.present? %>
        <div data-bind="visible: contactPhone().length > 0" class='contact-detail'>
          <i class='icon-phone-sign'></i> <span property="telephone" data-bind="text: contactPhone"><%= organization.cached_contact_phone %></span>
        </div>
      <% end %>
    </div>

    <div class='organization-description' property="description" datatype="rdf:HTML">
      <% if @preview %>
        <div data-bind="html: formattedDescription"></div>
      <% else %>
        <%= simple_format(organization.description) %>
      <% end %>
    </div>
    
    <div>
      <% if @preview || organization.cached_twitter.present? %>
        <div data-bind="visible: twitter().length > 0" class='contact-detail'>
          <i class='icon-twitter'></i> <a data-bind="text: twitter, attr: {href: twitterUrl}" href='http://twitter.com/<%= organization.cached_twitter %>'><%= organization.cached_twitter %></a>
        </div>
      <% end %>

      <% if @preview || organization.cached_facebook.present? %>
        <div data-bind="visible: facebook().length > 0" class='contact-detail'>
          <i class='icon-facebook'></i> <a data-bind="text: facebookLabel, attr: {href: facebook}" href='<%= organization.cached_facebook %>'><%= organization.cached_facebook.try(:split, '/').try(:last) %></a>
        </div>
      <% end %>

      <% if @preview || organization.cached_linkedin.present? %>
        <div data-bind="visible: linkedin().length > 0" class='contact-detail'>
          <i class='icon-linkedin-sign'></i> <a data-bind="text: linkedinLabel, attr: {href: linkedin}" href='<%= organization.cached_linkedin %>'><%= organization.cached_linkedin.try(:split, '/').try(:last) %></a>
        </div>
      <% end %>
    </div>

    <p>
      <em>Member since: <%= @member.created_at.strftime("%B %Y")%></em>
    </p>

  </div>

  <% if @preview %>
    <script type="text/javascript">
        function OrganisationViewModel() {
            this.name         = ko.observable("<%= organization.name %>");
            this.description  = ko.observable("<%= escape_javascript(organization.description) %>");
            this.url          = ko.observable("<%= organization.url %>");
            this.imageSrc     = ko.observable("url(<%= organization.logo.rectangular.url %>)");
            this.contactName  = ko.observable("<%= organization.cached_contact_name %>");
            this.contactPhone = ko.observable("<%= organization.cached_contact_phone %>");
            this.contactEmail = ko.observable("<%= organization.cached_contact_email %>");
            this.twitter      = ko.observable("<%= organization.cached_twitter %>");
            this.facebook     = ko.observable("<%= organization.cached_facebook %>");
            this.linkedin     = ko.observable("<%= organization.cached_linkedin %>");
            this.mailto       = ko.computed(function() {
              return 'mailto:' + this.contactEmail();
            }, this);
            this.twitterUrl   = ko.computed(function() {
              return 'http://twitter.com/' + this.twitter();
            }, this);
            this.facebookLabel= ko.computed(function() {
              return this.facebook().split('/').pop();
            }, this);
            this.linkedinLabel= ko.computed(function() {
              return this.linkedin().split('/').pop();
            }, this);
            this.formattedDescription = ko.computed(function() {
              str = this.description().replace(/\r\n?/, "\n");
              str = $.trim(str);
              if (str.length > 0) {
                str = str.replace(/\n\n+/g, '</p><p>');
                str = str.replace(/\n/g, '<br />');
                str = '<p>' + str + '</p>';
              }
              return str;
            }, this);
            this.updateImage = function() {
              input = $('#member_organization_attributes_logo')[0]
              if (input.files[0] && window.FileReader) {
                reader = new FileReader();
                reader.onloadend = function( ){
                    window.organizationPreview.imageSrc("url("+this.result+")");
                }
                reader.readAsDataURL(input.files[0]);
              }
            };
        };
        window.organizationPreview = new OrganisationViewModel()
        ko.applyBindings(window.organizationPreview);
    </script>
  <% end %>
  
</div>






