<div class='organization' vocab="http://schema.org/" typeOf="Organization">

  <h2 property="name"<% if @preview %> data-bind="text: name"<% end %>><%= organization.name %></h2>

  <% unless @member.supporter? %>
    <div class='organization-logo pull-right' 
         style='background-image: url(<%= organization.logo.rectangular.url %>)'
         <% if @preview %> data-bind='style: {backgroundImage: imageSrc}'<% end %> >
    </div>
  <% end %>

  <div class='<%= @member.supporter? ? '' : 'organization-content' %>'>
  
    <i class='icon icon-home'></i> <a property="url"<% if @preview %> data-bind="text: url, attr: {href: url}"<% end %> href='<%= organization.url %>'><%= organization.url%></a>

    <div class='organization-description' property="description" datatype="rdf:HTML">
      <% if @preview %>
        <div data-bind="html: formattedDescription"></div>
      <% else %>
        <%= simple_format(organization.description) %>
      <% end %>
    </div>
    
  </div>

  <% if @preview %>
    <script type="text/javascript">
        function OrganisationViewModel() {
            this.name        = ko.observable("<%= organization.name %>");
            this.description = ko.observable("<%= escape_javascript(organization.description) %>");
            this.url         = ko.observable("<%= organization.url %>");
            this.imageSrc    = ko.observable("url(<%= organization.logo.rectangular.url %>)");
            this.formattedDescription = ko.computed(function() {
              str = this.description().replace(/\r\n?/, "\n");
              str = $.trim(str);
              if (str.length > 0) {
                str = str.replace(/\n\n+/g, '</p><p>');
                str = str.replace(/\n/g, '<br />');
                str = '<p>' + str + '</p>';
              }
              return str;
            }, this);
            this.updateImage = function() {
              input = $('#member_organization_attributes_logo')[0]
              if (input.files[0] && window.FileReader) {
                reader = new FileReader();
                reader.onloadend = function( ){
                    window.organizationPreview.imageSrc("url("+this.result+")");
                }
                reader.readAsDataURL(input.files[0]);
              }
            };
        };
        window.organizationPreview = new OrganisationViewModel()
        ko.applyBindings(window.organizationPreview);
    </script>
  <% end %>
  
</div>






